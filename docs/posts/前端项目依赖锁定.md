---
date: 2022-02-09
title: 前端项目依赖锁定
categories: [前端]
---

> 参考文章： [npm/yarn lock 真香](https://segmentfault.com/a/1190000039684460)

> 以下是以 Q&A 的形式提炼了一下本文重点：
>
> 1. 为什么不能直接删除 package-lock.json 文件？
>    因为 package-lock.json 是用来锁定项目依赖版本的。
>
> 2. 为什么要锁定版本？
>    如果不锁定版本，不同的环境和时间安装的同一个依赖就有可能在版本上有差异，有差异就有可能带来表现不一致的问题。
>    （比如某个依赖的 2.0.7 版本有 bug，2.0.6 版本没有。那么安装 2.0.7 版本的环境就会有问题，而安装 2.0.6 版本的环境就没问题。）
>
> 3. 锁定版本的原理？
>    在项目中添加一个临时且更详细的依赖信息文件(.json)，后面任何时候和环境安装依赖的时候 都优先按照这个 json 文件为准(前提是 json 文件中的版本和项目规定的版本兼容)。
>
> 4. 锁定版本有什么方法？
>
>    - npm5 之前，通过手动运行 npm shrinkwrap 命令生成依赖锁定文件 npm-shrinkwrap.json (这个文件可以理解为当前依赖的快照)。
>    - npm5 之后，运行 npm install 命令时候，检测当前项目是否有 package-lock.json 文件(作用和内容基本与 npm-shrinkwrap.json 一致)，有的话按照 package-lock.json 里的依赖信息还原安装，没有的话就按照 package.json 文件中声明的版本进行安装，同时生成 package-lock.json。
>
> 5. 依赖安装时候 package-lock.json 和 package.json 的优先级
>    - package-lock.json 里的依赖版本如果兼容 package.json 里的对应依赖版本，则直接用 package-lock.json 中依赖信息
>    - package-lock.json 里的依赖版本如果不兼容 package.json 里的对应依赖版本，则使用 package.json 里的版本，同时把当前用的依赖信息更新到 package-lock.json 中。

## 依赖不锁定(删除 package-lock.json)带来的问题

一句话来说就是，依赖包更新的版本，而刚好这个新版本有问题。

> 接下来这里需要先了解一下`package.json`中依赖包版本号前的 `^`、`~` 等符号都是什么意思。
>
> [package.json 文件内容解读](./package.json文件内容解读.html)

比如项目中用的依赖包在`package.json`中的声明是这样的`pkg: "^2.0.4"`。

本地运行时候装的 pkg 依赖版本是`2.0.6`，运行没问题；

而线上运行装的依赖就是`2.0.7`，同时，偏偏这个`2.0.7`版本的依赖有 bug，这样线上环境对应的功能就会收到影响甚至直接不能用。

**这就是因为两个环境版本不一致导致的表现不一致。**

## 如何锁定依赖

由于以上那种不同的环境安装的依赖版本会存在差异而有可能带来问题的情况下，就需要对版本有**锁定机制**。

### npm-shrinkwrap.json

`npm5` 之前可以通过 `npm-shrinkwrap` 实现本本锁定。通过运行 `npm shrinkwrap`，会在当前目录下生成一个 `npm-shrinkwrap.json` 文件，它是 `package.json` 中列出的每个依赖项的大型列表，应安装的**特定版本**、**模块的位置（URI）**、验证模块完整性的**哈希**、它需要的**包列表**、以及**依赖项列表**。

运行 npm install 的时候会优先使用 `npm-shrinkwrap.json` 进行安装，没有则使用 `package.json` 进行安装。

### package-lock.json

在 `npm5` 版本后，当我们运行 `npm intall` 发现会生成一个新文件 `package-lock.json`，内容跟上面提到的 `npm-shrinkwrap.json` 基本一样。
当项目中已有 `package-lock.json` 文件，在安装项目依赖时，将以该文件为主进行解析安装指定版本依赖包，而不是使用 `package.json` 来解析和安装模块。因为 `package-lock` 为每个模块及其每个依赖项指定了版本，位置和完整性哈希。

**所以它每次创建的安装都是相同的。无论你使用什么设备，或者将来安装它都无关紧要，每次都应该给你相同的结果。**

## npm5.4.2 版本后的 install 规则

如果只有一个 `package.json` 文件，运行 `npm install` 会根据它生成一个 `package-lock.json` 文件，这个文件相当于本次 install 的一个快照，它不仅记录了 `package.json` 指明的直接依赖的版本，也记录了间接依赖的版本。

> 注意：
>
> cnpm install 不会创建 package-lock.json，cnpm 解决的只是依赖源的问题。

如果 `package.json` 的 `semver-range version` 和 `package-lock.json` 中版本兼容(`package-lock.json` 版本在 `package.json` 指定的版本范围内)，即使此时 `package.json` 中有新的版本，执行 `npm install` 也还是会根据 `package-lock.json` 下载。

如果手动修改了 `package.json` 的 `version ranges`，且和 `package-lock.json` 中版本不兼容，那么执行 `npm install` 时 `package-lock.json` 将会更新到兼容 `package.json` 的版本。

一句话总结就是，没有 `package-lock.json` 就创建。有的话如果`package-lock.json` 中的版本和 `package.json` 中的版本兼容，那就用 `package-lock.json` 中的版本，否则用 `package.json` 且同时更新 `package-lock.json` 中的版本信息。即：**只要 `package-lock.json` 里版本符合要求就用，不符合要求，给他改成符合要求的**

## cnpm 呢？

`cnpm ` 只是改变了依赖的下载源，在执行 `install` 命令时候，不会创建 `package-lock.json`。并且就算你项目中有 `package-lock.json` 文件，`cnpm` 也不会识别，仍会根据 `package.json` 来安装，就很任性不讲规矩。

因此尽量不要直接使用 `cnpm install` 安装项目依赖包。

如果又想解决 npm 慢，又想生成 `package-lock.json` 文件，那么可以通过直接配置 `npm ` 代理：

```shell
// 设置淘宝镜像代理
npm config set registry https://registry.npm.taobao.org

// 查看已设置代理
npm config get registry
```

设置这些全局代理可能还是不能满足下载一些特定依赖包（在没有 `VPN` 情况下），比如：`node-sass`、`puppeteer`、`chromedriver`、`electron` 等。可以通过 `.npmrc` 文件设置具体依赖包的国内镜像。该文件在项目 `npm install` 时会被加载读取，优先级高于 `npm` 全局设置。

```env
// .npmrc

registry=https://registry.npm.taobao.org/
sass_binary_site=http://npm.taobao.org/mirrors/node-sass
chromedriver_cdnurl=http://npm.taobao.org/mirrors/chromedriver
electron_mirror=http://npm.taobao.org/mirrors/electron/
puppeteer_download_host=http://npm.taobao.org/mirrors/chromium-browser-snapshots/
```

## yarn 呢？

`yarn` 相对于 `npm` 主要做了以下几个优化：

- **多个依赖并行安装**：`npm` 是按照队列执行每个依赖安装(排队一个一个来)，`yarn` 是同步执行所有任务(一口气一起来)。
- **离线缓存**：如果已经安装过的软件包，`yarn` 会做一下包缓存，下次安装就从缓存中取，而不是像 npm 每次都从网络下载。
- **版本统一**：`yarn.lock` 记录了确切的依赖信息。(其实这个后面的 `npm` 不是也有了吗，不算优势了吧)
- **语义化**：`yarn` 改变了一些 `npm` 命令，比如 `yarn add/remove` 代替了 `npm install/uninstall` 。



所以，yarn install 的时候也会生成 `yarn.lock`文件。基本和 `npm-shrinkwrap.json`以及 `package-lock.json` 文件 作用一致。
